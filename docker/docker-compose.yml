version: "3.9"

services:
    app:
        build:
            context: ..
            dockerfile: docker/php/Dockerfile
        volumes:
            - ../:/var/www/html
            - ./php/entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
            - ./php/php.ini:/usr/local/etc/php/conf.d/php.ini:ro
            - ./supervisor/supervisord.conf:/etc/supervisor/conf.d/supervisord.conf:ro
        env_file:
            - ./env/app.env
        ports:
            - "${APP_WS_PORT:-6001}:6001"
        environment:
            TZ: "${TZ:-UTC}"
        restart: unless-stopped
        ulimits:
            nofile: 65536
        deploy:
            resources:
                limits:
                    cpus: "1.00"
                    memory: "1g"
                reservations:
                    memory: "512m"
        networks: [appnet]

    nginx:
        build:
            context: ./nginx
            dockerfile: Dockerfile
        ports:
            - "${APP_HTTP_PORT:-8080}:80"
        volumes:
            - ../:/var/www/html
            - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
        depends_on:
            - app
        restart: unless-stopped
        ulimits:
            nofile: 65536
        deploy:
            resources:
                limits:
                    cpus: "0.50"
                    memory: "512m"
                reservations:
                    memory: "256m"
        networks: [appnet]

    next:
        image: node:20-alpine
        working_dir: /app
        command: sh -c "npm install && npm run dev -- -H 0.0.0.0 -p 3000"
        ports:
            - "${APP_NEXT_PORT:-3000}:3000"
        volumes:
            - ../next:/app
            - npm_cache:/home/node/.npm
            - node_modules:/app/node_modules
        env_file:
            - ./env/next.env
        restart: unless-stopped
        ulimits:
            nofile: 65536
        deploy:
            resources:
                limits:
                    cpus: "1.00"
                    memory: "1g"
                reservations:
                    memory: "512m"
        networks: [appnet]

    postgres:
        image: postgres:15-alpine
        environment:
            POSTGRES_USER: gchat
            POSTGRES_PASSWORD: gchat
            POSTGRES_DB: gchat
            TZ: "${TZ:-UTC}"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        ports:
            - "55432:5432"
        restart: unless-stopped
        ulimits:
            nofile: 65536
        deploy:
            resources:
                limits:
                    cpus: "1.00"
                    memory: "1g"
                reservations:
                    memory: "512m"
        networks: [appnet]

    redis:
        image: redis:7-alpine
        volumes:
            - redis_data:/data
        restart: unless-stopped
        ulimits:
            nofile: 65536
        deploy:
            resources:
                limits:
                    cpus: "0.50"
                    memory: "256m"
                reservations:
                    memory: "128m"
        networks: [appnet]

volumes:
    postgres_data:
    redis_data:
    npm_cache:
    node_modules:

networks:
    appnet:
